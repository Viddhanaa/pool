services:
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: asdminer
    command: 
      - postgres
      - -c
      - listen_addresses=*
      - -c
      - shared_preload_libraries=pg_stat_statements
      - -c
      - pg_stat_statements.track=all
      - -c
      - max_connections=200
      - -c
      - shared_buffers=256MB
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    ports:
      - "6379:6379"

  backend:
    build: ./backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - ./backend/.env
    environment:
        DATABASE_URL: postgres://postgres:postgres@postgres:5432/asdminer
        REDIS_URL: redis://redis:6379
        RPC_URLS: http://geth1:8545,http://geth2:8545
    ports:
      - "4000:4000"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://localhost:4000/health', res => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))\""
        ]
      timeout: 5s
      retries: 8
      start_period: 20s
    profiles:
      - app

  # web/admin preview services are defined below; removing stray invalid blocks

  web:
    build:
      context: ./web
      args:
        - VITE_API_BASE=/api
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "4173:80"
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - app

  admin:
    build:
      context: ./admin
      args:
        - VITE_API_BASE=/api
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "4174:80"
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - app

  rpc-api-docs:
    build:
      context: ./rpc-api-docs-&-assistant
      args:
        - GEMINI_API_KEY=${GEMINI_API_KEY:-AIzaSyAb-CSiAPe6SBKurwd1kDRCSHz2op_SROA}
    restart: unless-stopped
    ports:
      - "3002:80"
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - app

  geth1-init:
    image: ethereum/client-go:v1.13.14
    volumes:
      - ./infra/geth/genesis.json:/genesis.json:ro
      - geth1data:/data
    entrypoint: ["geth"]
    command: ["init","--datadir","/data","/genesis.json"]
    profiles: [chain]

  geth1-import:
    image: ethereum/client-go:v1.13.14
    depends_on:
      - geth1-init
    volumes:
      - geth1data:/data
      - ./infra/geth/admin.key:/signer1.key:ro
      - ./infra/geth/pass.txt:/pass.txt:ro
    entrypoint: ["geth","account","import"]
    command: ["--datadir","/data","--password","/pass.txt","/signer1.key"]
    profiles: [chain]

  geth1:
    image: ethereum/client-go:v1.13.14
    restart: unless-stopped
    depends_on:
      - geth1-import
    entrypoint: ["geth"]
    command:
      [
        "--datadir","/data",
        "--syncmode","full",
        "--networkid","202401",
        "--authrpc.port","8551",
        "--http","--http.addr","0.0.0.0","--http.vhosts","*","--http.api","eth,net,web3,txpool,personal,admin",
        "--ws","--ws.addr","0.0.0.0","--ws.api","eth,net,web3,txpool,admin",
        "--http.corsdomain=*",
        "--port","30303",
        "--allow-insecure-unlock",
        "--unlock","0xcd2d7b8aa8a679b59a03eb0f4870518bc266bc7f",
        "--password","/pass.txt",
        "--mine",
        "--miner.etherbase","0xcd2d7b8aa8a679b59a03eb0f4870518bc266bc7f",
        "--nodekeyhex","1111111111111111111111111111111111111111111111111111111111111111",
        "--metrics",
        "--pprof",
        "--pprof.addr","0.0.0.0",
        "--pprof.port","6060"
      ]
    volumes:
      - geth1data:/data
      - ./infra/geth/pass.txt:/pass.txt:ro
      - ./infra/geth/static-nodes.json:/data/static-nodes.json:ro
    ports:
      - "8545:8545"
      - "8546:8546"
      - "30303:30303"
      - "6060:6060"
    healthcheck:
      test: ["CMD-SHELL", "curl -s -H 'Content-Type: application/json' -d '{\"jsonrpc\":\"2.0\",\"method\":\"net_version\",\"params\":[],\"id\":1}' http://localhost:8545 >/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 8
      start_period: 30s
    profiles: [chain]

  geth2-init:
    image: ethereum/client-go:v1.13.14
    volumes:
      - ./infra/geth/genesis.json:/genesis.json:ro
      - geth2data:/data
    entrypoint: ["geth"]
    command: ["init","--datadir","/data","/genesis.json"]
    profiles: [chain]

  geth2-import:
    image: ethereum/client-go:v1.13.14
    depends_on:
      - geth2-init
    volumes:
      - geth2data:/data
      - ./infra/geth/signer2.key:/signer2.key:ro
      - ./infra/geth/pass.txt:/pass.txt:ro
    entrypoint: ["geth","account","import"]
    command: ["--datadir","/data","--password","/pass.txt","/signer2.key"]
    profiles: [chain]

  geth2:
    image: ethereum/client-go:v1.13.14
    restart: unless-stopped
    depends_on:
      - geth2-import
    entrypoint: ["geth"]
    command:
      [
        "--datadir","/data",
        "--syncmode","full",
        "--networkid","202401",
        "--authrpc.port","9551",
        "--http","--http.addr","0.0.0.0","--http.vhosts","*","--http.api","eth,net,web3,txpool,personal,admin",
        "--ws","--ws.addr","0.0.0.0","--ws.api","eth,net,web3,txpool,admin",
        "--http.corsdomain=*",
        "--port","30304",
        "--allow-insecure-unlock",
        "--unlock","0x45c3c0c9c2c4416b23966fd4e3acec8e84a0f434",
        "--password","/pass.txt",
        "--mine",
        "--miner.etherbase","0x45c3c0c9c2c4416b23966fd4e3acec8e84a0f434",
        "--nodekeyhex","2222222222222222222222222222222222222222222222222222222222222222",
        "--metrics",
        "--pprof",
        "--pprof.addr","0.0.0.0",
        "--pprof.port","7060"
      ]
    volumes:
      - geth2data:/data
      - ./infra/geth/pass.txt:/pass.txt:ro
      - ./infra/geth/static-nodes.json:/data/static-nodes.json:ro
    ports:
      - "9545:8545"
      - "9546:8546"
      - "30304:30304"
      - "7060:7060"
    healthcheck:
      test: ["CMD-SHELL", "curl -s -H 'Content-Type: application/json' -d '{\"jsonrpc\":\"2.0\",\"method\":\"net_version\",\"params\":[],\"id\":1}' http://localhost:8545 >/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 8
      start_period: 30s
    profiles: [chain]

  blockscout-db:
    image: postgres:15-alpine
    restart: unless-stopped
    command:
      - "postgres"
      - "-c"
      - "max_connections=300"
      - "-c"
      - "shared_buffers=256MB"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: blockscout
    volumes:
      - blockscout-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles: [chain, explorer]

  blockscout:
    image: blockscout/blockscout:latest
    restart: unless-stopped
    depends_on:
      blockscout-db:
        condition: service_healthy
      geth1:
        condition: service_started
    command: sh -c "bin/blockscout eval \"Elixir.Explorer.ReleaseTasks.create_and_migrate()\" && bin/blockscout start"
    environment:
      # Database
      DATABASE_URL: postgresql://postgres:postgres@blockscout-db:5432/blockscout
      ECTO_USE_SSL: "false"
      SECRET_KEY_BASE: 0f82a34c7d0f4b139f0e4c29b875a1d2
      # RPC Endpoints (Internal)
      ETHEREUM_JSONRPC_HTTP_URL: http://geth1:8545
      ETHEREUM_JSONRPC_WS_URL: ws://geth1:8546
      ETHEREUM_JSONRPC_VARIANT: geth
      # Network Info
      NETWORK: "BTC Diamond Chain"
      SUBNETWORK: "Block time ~5s | Block reward in BTCD"
      CHAIN_ID: "202401"
      COIN: BTCD
      # API Settings
      PORT: "4002"
      BLOCKSCOUT_HOST: "0.0.0.0"
      API_V2_ENABLED: "true"
      # Features
      DISABLE_EXCHANGE_RATES: "true"
      INDEXER_DISABLE_INTERNAL_TRANSACTIONS_FETCHER: "false"
      EMISSION_FORMAT: POA
      BLOCK_TRANSFORMER: clique
      # Public Domain (for API responses)
      BLOCKSCOUT_PROTOCOL: https
      BLOCKSCOUT_HOST_URL: https://geth-api.asdchain.io
    ports:
      - "4002:4002"
    profiles: [chain, explorer]

  blockscout-frontend:
    image: ghcr.io/blockscout/frontend:latest
    restart: unless-stopped
    depends_on:
      - blockscout
    environment:
      # Public URLs (via Cloudflare Tunnel)
      NEXT_PUBLIC_APP_HOST: scan.viddhana.com
      NEXT_PUBLIC_APP_PROTOCOL: https
      # Route frontend API via same origin using proxy path /api
      NEXT_PUBLIC_API_HOST: scan.viddhana.com
      NEXT_PUBLIC_API_PROTOCOL: https
      NEXT_PUBLIC_STATS_API_HOST: https://scan.viddhana.com
      NEXT_PUBLIC_API_WEBSOCKET_PROTOCOL: wss
      # Internal API
      API_HOST: blockscout
      API_PORT: "4002"
      # Network Info
      NEXT_PUBLIC_NETWORK_NAME: "Viddahana Chain"
      NEXT_PUBLIC_NETWORK_SHORT_NAME: BTCD
      NEXT_PUBLIC_NETWORK_ID: "202401"
      NEXT_PUBLIC_NETWORK_CURRENCY_NAME: "Viddahana"
      NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL: BTCD
      NEXT_PUBLIC_NETWORK_CURRENCY_DECIMALS: "18"
      # RPC URL (Public)
      NEXT_PUBLIC_NETWORK_RPC_URL: https://geth-rpc1.asdchain.io
      # Features - Charts disabled due to v1 API incompatibility
      # NEXT_PUBLIC_HOMEPAGE_CHARTS: '["daily_txs"]'
      NEXT_PUBLIC_VISUALIZE_API_HOST: https://scan.viddhana.com
      NEXT_PUBLIC_IS_TESTNET: "false"
      NEXT_PUBLIC_PROMOTE_BLOCKSCOUT_IN_TITLE: "false"
      NEXT_PUBLIC_OG_DESCRIPTION: "Viddahana Chain explorer - Block time 5s - Block reward 2 BTCD - Native coin BTCD"
    # Expose only to internal network; proxied to host via blockscout-proxy
    ports: []
    profiles: [chain, explorer]

  # Dev reverse proxy to make Blockscout visible inside iframe-based browsers (VS Code Simple Browser)
  # It strips X-Frame-Options and adds a permissive frame-ancestors CSP for local use.
  blockscout-proxy:
    image: nginx:alpine
    restart: unless-stopped
    depends_on:
      - blockscout-frontend
    volumes:
      - ./infra/nginx/blockscout-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "4001:4001"
    profiles: [chain, explorer]

  # Lightweight static site for RPC documentation & live console
  rpc-docs:
    image: nginx:alpine
    restart: unless-stopped
    volumes:
      - ./infra/rpc-docs:/usr/share/nginx/html:ro
      - ./infra/rpc-docs/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "4180:80"
    profiles: [app]

  # Landing page service
  landingpage:
    build:
      context: ./landingpages
    restart: unless-stopped
    ports:
      - "3001:80"
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost/health || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
    profiles: [app]

  block-reward-bot:
    build: ./block-reward-bot
    restart: unless-stopped
    depends_on:
      - geth1
    environment:
      RPC_URL: http://geth1:8545
      # Use Hardhat account #0 (funded with 0.4 VIDDHANA from geth1)
      ADMIN_PRIVATE_KEY: ac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
    profiles: [chain]

  # Monitoring Stack
  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    volumes:
      - ./infra/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./infra/prometheus/rules:/etc/prometheus/rules
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    profiles: [monitoring]

  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_INSTALL_PLUGINS=
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infra/grafana/datasources:/etc/grafana/provisioning/datasources
      - ./infra/grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml
      - ./infra/grafana/dashboards:/etc/grafana/dashboards
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    profiles: [monitoring]

  loki:
    image: grafana/loki:latest
    restart: unless-stopped
    command: -config.file=/etc/loki/loki-config.yml
    volumes:
      - ./infra/loki/loki-config.yml:/etc/loki/loki-config.yml
      - loki_data:/loki
    ports:
      - "3100:3100"
    profiles: [monitoring]

  promtail:
    image: grafana/promtail:latest
    restart: unless-stopped
    command: -config.file=/etc/promtail/promtail-config.yml
    volumes:
      - ./infra/promtail/promtail-config.yml:/etc/promtail/promtail-config.yml
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/log:/var/log
    depends_on:
      - loki
    profiles: [monitoring]

  # Exporters for detailed metrics
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    restart: unless-stopped
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:postgres@postgres:5432/asdminer?sslmode=disable"
    ports:
      - "9187:9187"
    depends_on:
      - postgres
    profiles: [monitoring]

  redis-exporter:
    image: oliver006/redis_exporter:latest
    restart: unless-stopped
    environment:
      REDIS_ADDR: "redis:6379"
    ports:
      - "9121:9121"
    depends_on:
      - redis
    profiles: [monitoring]

  node-exporter:
    image: prom/node-exporter:latest
    restart: unless-stopped
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    ports:
      - "9100:9100"
    profiles: [monitoring]

volumes:
  pgdata: {}
  geth1data: {}
  geth2data: {}
  prometheus_data: {}
  grafana_data: {}
  loki_data: {}
  blockscout-db-data: {}
